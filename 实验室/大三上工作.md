# 安全代码扫描开发工作内容

## LarkScanner

`LarkScanner`是已经写好的脚本，执行这个脚本可以执行国军标的检测文件`clang-tidy`

- `clang-tidy/src/gjb8114`目录下的规则文件的编写：一个头文件.h，一个源文件`.cpp`，以表格中的序号命名

- 编写完成之后，需要在`gjb/samples`目录下编写对应的两个源文件，一个是遵守规则的，一个是不遵守规则的，还是以序号命名，如果扫描出来之后遵守规则没有扫到然后不遵守规则的扫到了，那么就算成功

- 编译命令

  ~~~cpp
  conan install .. //只用拉一次
  cmake -DPACKAGE_VERSION=1.0.1 -DCMAKE_C_COMPILER=/usr/bin/gcc-9 -DCMAKE_CXX_COMPILER=/usr/bin/g++-9 ..
  make
  ~~~

  `make`完毕之后在`build/bin`目录下生成可执行文件`larkscan`

  然后我们需要跑程序来检测`samples`目录下的各个程序

  ~~~cpp
  ctest -VV
  ~~~

  或者我们直接调用可执行程序`larkscan`来扫描样本目录的程序(我的第一个不行，只能用第二个目前)

  ~~~cpp
  // 现在我们在build目录
  ./bin/larkscan ../gjb/
  ~~~

- 我们需要把自己编译的规则拿到`llvm`工程当中去编译，见第二条，这样生成的新文件就包含了我们写的规则了，然后把生成的`clang-tidy`在我们的项目中`clang-tidy/bin`目录下替换掉，然后再把`clang-tidy/bin`和`clang-tidy/lib`目录再次拷贝到`/opt/LarkStudio5/LarkScanner`

~~~bash
cd /opt/LarkStudio5/LarkScanner

sudo cp /home/lzx0626/DavidingPlus/Lark5/larkscanner/clang-tidy/bin . -r
sudo cp /home/lzx0626/DavidingPlus/Lark5/larkscanner/clang-tidy/lib . -r
~~~

## 国军标规则编写

- 国军标规则编写的流程

  注意，用官方的`llvm`工程它本身是不包含我们自己的模块的，想要编译我们自己的模块需要添加一些东西，见`gitlab`:

  [点这里，注意挂梯子](http://192.168.1.248/larkstudio/larkscanner/-/tree/feature-chenb-gjb-rules)

  包含完之后就可以编译，然后注意每次加入新的规则都要将对应的先加入到`Gjb8114TidyModule.cpp`中和`CMakeLists.txt`

<img src="https://img-blog.csdnimg.cn/c7063ec3b4c74666bbb57badfd65208f.png" alt="image-20230911151056393" style="zoom:80%;" />

- (现在不需要)需要编写新的规则的时候，是有样本文件供我们参考的，现在工程中已经把所有的模板文件创建好了，所以不需要

  ~~~bash
  sudo apt install python-is-python2 #只安装一次python2，用python3会出问题
  
  cd llvm-project-10.0.0/clang-tools-extra/clang-tidy #进入到这个目录
  
  python2 add_new_check.py gjb8114 r_x_y_z #对应规则R-x-y-z，尽量一次写对，不然不好删除
  ~~~

  然后进行规则编写，然后进行自测

- 拉取代码覆盖`llvm`工程下的文件

  ~~~bash
  # 注意自己写的部分需要提前备份，否则给你替换掉了，这一点要尤其注意！！！
  cp /home/lzx0626/DavidingPlus/Lark5/larkscanner/clang-tidy/src/gjb8114 /home/lzx0626/DavidingPlus/Lark5/llvm-project-10.0.0/clang-tools-extra/clang-tidy/ -r
  ~~~

- `llvm`工程的编译

  记得使用`gcc-9`，不要乱切`gcc`版本，因为这样很容易导致代码的重新编译!!!

  编译完成后`build/bin/clang-tidy`目录下的文件就是我们需要的，按照前面说的进行拷贝

  ~~~bash
  # 跑之前gcc版本最好切为gcc-9，虽然我下面也设置了!!!!!
  
  cd llvm-project-10.0.0
  mkdir build #如果不存在
  cd build
  
  cmake -DCMAKE_C_COMPILER=/usr/bin/gcc-9 -DCMAKE_CXX_COMPILER=/usr/bin/g++-9 -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra" -DLLVM_TARGETS_TO_BUILD=X86 -DCMAKE_BUILD_TYPE=Release -G "Unix Makefiles" ../llvm
  
  # 我的电脑是6核，量力而为
  make -j 4
  ~~~

- 上传

  ![image-20230911155204282](https://img-blog.csdnimg.cn/d07180976ca1423d8009461dcde58e13.png)

## 使用clang-tidy

其中修复功能我们不需要管，注意有两个`clang-tidy`，一个是通过apt管理下载的官方的`clang-tidy`，另外一个是我们通过`llvm`工程添加了测试模块之后的自己的`clang-tidy`，这两个需要注意，我们自己的就在目录下`./clang-tidy`就好了，注意两个不要搞混了

<img src="https://img-blog.csdnimg.cn/05574a2139404251b355aeae7b85268e.png" alt="image-20230912102946085" style="zoom:80%;" />

## 抽象语法树

查看抽象语法树

~~~bash
clang -c -Xclang -ast-dump test.cpp # test.cpp就是需要查看的cpp文件
~~~

结果示例：

<img src="https://img-blog.csdnimg.cn/7a5a100c8772432b849e4e2b5c2fed56.png" alt="image-20230914145403241" style="zoom: 67%;" />

### 对象树匹配网站

[AST Matcher Reference (llvm.org)](https://clang.llvm.org/docs/LibASTMatchersReference.html)

### clang-query

使用示例

<img src="D:\Code\Md_Files\typora-user-images\image-20230914150823694.png" alt="image-20230914150823694" style="zoom:67%;" />

## 目前写了的条数记录

~~~bash
# A_1_5_1 R_1_6_18 R_1_6_12 R_1_5_2 R_1_6_5

# 拉取git代码，然后把别人更新的代码拷贝到llvm对应的目录

# 自己先把代码拉取了

# 首先需要把我自己的代码拷贝出去
cd /home/lzx0626/DavidingPlus/Lark5/llvm-project-10.0.0/clang-tools-extra/clang-tidy/gjb8114

# 后续自己添加
cp A_1_5_1* /home/lzx0626/DavidingPlus/Lark5/llvm-project-10.0.0
cp R_1_6_18* /home/lzx0626/DavidingPlus/Lark5/llvm-project-10.0.0
cp R_1_6_12* /home/lzx0626/DavidingPlus/Lark5/llvm-project-10.0.0
cp R_1_5_2* /home/lzx0626/DavidingPlus/Lark5/llvm-project-10.0.0
cp R_1_6_5* /home/lzx0626/DavidingPlus/Lark5/llvm-project-10.0.0

# 拷贝git拉取的代码修改的部分到llvm目录
cp /home/lzx0626/DavidingPlus/Lark5/larkscanner/clang-tidy/src/gjb8114/* . -r

# 移动回去
cd /home/lzx0626/DavidingPlus/Lark5/llvm-project-10.0.0/
mv *.cpp *.h /home/lzx0626/DavidingPlus/Lark5/llvm-project-10.0.0/clang-tools-extra/clang-tidy/gjb8114
~~~

## 进程记录

~~~bash
A_1_5_1：自测完成(已上传，等待反馈)
R_1_6_18：gets函数被c++废弃了，检测会报出未定义，没办法用我自己的规则(算完成了？)
R_1_6_12：自测基本完成，但是 浮点数/0 这个东西会有隐式转换，这个我目前没办法解决(已上传，等待反馈)
R_1_5_2：自测完成(已上传，等待反馈)
R_1_6_5：正在编写
~~~

